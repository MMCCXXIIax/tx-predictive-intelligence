<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TX Trading Intelligence Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header h1 {
            color: #2c3e50;
            font-size: 1.8rem;
            font-weight: 700;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 10px;
        }
        
        .status-online { background: #2ecc71; }
        .status-offline { background: #e74c3c; }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1.5rem;
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .card h3 {
            color: #2c3e50;
            margin-bottom: 1rem;
            font-size: 1.2rem;
            border-bottom: 2px solid #3498db;
            padding-bottom: 0.5rem;
        }
        
        .alert-item {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 0.8rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .alert-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .pattern-name {
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .confidence {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.2rem 0.6rem;
            border-radius: 15px;
            font-size: 0.9rem;
        }
        
        .symbol {
            color: #f1c40f;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .price {
            color: #2ecc71;
            font-weight: bold;
        }
        
        .scan-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #ecf0f1;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .scan-id {
            font-weight: bold;
            color: #3498db;
        }
        
        .market-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .market-item {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .market-symbol {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
        }
        
        .market-price {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        
        .market-status {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .btn {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            border: none;
            padding: 0.7rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e17055, #d63031);
        }
        
        .sound-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: #2ecc71;
            color: white;
            border: none;
            padding: 1rem;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .sound-off {
            background: #e74c3c;
        }
        
        .loading {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
        }
        
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
                padding: 1rem;
            }
            
            .header {
                padding: 1rem;
            }
            
            .header h1 {
                font-size: 1.4rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>TX Trading Intelligence <span id="status" class="status-indicator status-offline"></span></h1>
    </div>
    
    <button id="soundToggle" class="sound-toggle" title="Toggle Alert Sounds">üîä</button>
    
    <div class="dashboard-grid">
        <!-- Real-time Alerts -->
        <div class="card">
            <h3>üö® Live Alerts</h3>
            <div class="controls">
                <button class="btn" onclick="manualScan()">Force Scan</button>
                <button class="btn btn-danger" onclick="clearAlerts()">Clear</button>
            </div>
            <div id="alerts-container">
                <div class="loading">Waiting for alerts...</div>
            </div>
        </div>
        
        <!-- Market Overview -->
        <div class="card">
            <h3>üìä Market Overview</h3>
            <div id="market-container" class="market-grid">
                <div class="loading">Loading market data...</div>
            </div>
        </div>
        
        <!-- Scan Status -->
        <div class="card">
            <h3>üõ∞Ô∏è Scan Status</h3>
            <div id="scan-container">
                <div class="loading">Connecting...</div>
            </div>
        </div>
    </div>
    
    <audio id="alertSound" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmsfDDuW3PLNDK8AAAA=" type="audio/wav">
    </audio>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <script>
        class TXDashboard {
            constructor() {
                this.socket = null;
                this.soundEnabled = true;
                this.alertSound = document.getElementById('alertSound');
                this.init();
            }
            
            init() {
                this.setupUI();
                this.connectWebSocket();
                this.loadInitialData();
            }
            
            setupUI() {
                const soundToggle = document.getElementById('soundToggle');
                soundToggle.addEventListener('click', () => this.toggleSound());
                
                // Update sound button state
                this.updateSoundButton();
            }
            
            connectWebSocket() {
                // Try to connect to WebSocket for real-time updates
                try {
                    this.socket = io();
                    
                    this.socket.on('connect', () => {
                        this.updateStatus(true);
                        console.log('Connected to TX server');
                    });
                    
                    this.socket.on('disconnect', () => {
                        this.updateStatus(false);
                        console.log('Disconnected from TX server');
                    });
                    
                    this.socket.on('new_alert', (alert) => {
                        this.addAlert(alert);
                        this.playAlertSound();
                    });
                    
                    this.socket.on('scan_update', (scanData) => {
                        this.updateScanStatus(scanData);
                    });
                    
                    this.socket.on('market_update', (marketData) => {
                        this.updateMarketData(marketData);
                    });
                    
                } catch (error) {
                    console.log('WebSocket not available, using polling');
                    this.startPolling();
                }
            }
            
            startPolling() {
                // Fallback to polling if WebSocket not available
                setInterval(() => this.loadInitialData(), 5000);
            }
            
            async loadInitialData() {
                try {
                    // Load alerts
                    const alertsResponse = await fetch('/api/get_active_alerts');
                    const alertsData = await alertsResponse.json();
                    this.displayAlerts(alertsData.alerts || []);
                    
                    // Load scan status
                    const scanResponse = await fetch('/api/scan');
                    const scanData = await scanResponse.json();
                    this.updateScanStatus(scanData.last_scan);
                    this.updateMarketData(scanData.last_scan?.results || []);
                    
                    this.updateStatus(true);
                } catch (error) {
                    console.error('Failed to load data:', error);
                    this.updateStatus(false);
                }
            }
            
            displayAlerts(alerts) {
                const container = document.getElementById('alerts-container');
                
                if (!alerts || alerts.length === 0) {
                    container.innerHTML = '<div class="loading">No active alerts</div>';
                    return;
                }
                
                container.innerHTML = alerts.map(alert => this.createAlertHTML(alert)).join('');
            }
            
            addAlert(alert) {
                const container = document.getElementById('alerts-container');
                const alertHTML = this.createAlertHTML(alert);
                
                // Remove "no alerts" message if present
                if (container.querySelector('.loading')) {
                    container.innerHTML = '';
                }
                
                // Add new alert at the top
                container.insertAdjacentHTML('afterbegin', alertHTML);
                
                // Limit to 10 alerts
                const alerts = container.children;
                while (alerts.length > 10) {
                    container.removeChild(alerts[alerts.length - 1]);
                }
            }
            
            createAlertHTML(alert) {
                return `
                    <div class="alert-item">
                        <div class="alert-header">
                            <span class="pattern-name">${alert.pattern}</span>
                            <span class="confidence">${alert.confidence}</span>
                        </div>
                        <div class="symbol">${alert.symbol}</div>
                        <div class="price">$${alert.price}</div>
                        <div style="margin-top: 0.5rem; font-size: 0.9rem; opacity: 0.9;">
                            ${alert.time}
                        </div>
                        ${alert.explanation ? `
                            <div style="margin-top: 0.5rem; font-size: 0.85rem; opacity: 0.8;">
                                ${alert.explanation}
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            updateScanStatus(scanData) {
                const container = document.getElementById('scan-container');
                
                if (!scanData) {
                    container.innerHTML = '<div class="loading">No scan data</div>';
                    return;
                }
                
                container.innerHTML = `
                    <div class="scan-info">
                        <div>
                            <div class="scan-id">Scan #${scanData.id}</div>
                            <div style="font-size: 0.9rem; color: #7f8c8d;">${scanData.time}</div>
                        </div>
                        <div style="font-size: 1.2rem; color: #3498db;">
                            ${scanData.results?.length || 0} assets scanned
                        </div>
                    </div>
                `;
            }
            
            updateMarketData(results) {
                const container = document.getElementById('market-container');
                
                if (!results || results.length === 0) {
                    container.innerHTML = '<div class="loading">No market data</div>';
                    return;
                }
                
                container.innerHTML = results.map(result => `
                    <div class="market-item">
                        <div class="market-symbol">${result.symbol}</div>
                        <div class="market-price">$${result.price || 'N/A'}</div>
                        <div class="market-status">
                            ${result.status === 'pattern' ? 
                                `üî• ${result.pattern} (${(result.confidence * 100).toFixed(0)}%)` : 
                                result.status
                            }
                        </div>
                    </div>
                `).join('');
            }
            
            updateStatus(online) {
                const status = document.getElementById('status');
                status.className = `status-indicator ${online ? 'status-online' : 'status-offline'}`;
            }
            
            toggleSound() {
                this.soundEnabled = !this.soundEnabled;
                this.updateSoundButton();
                localStorage.setItem('txSoundEnabled', this.soundEnabled);
            }
            
            updateSoundButton() {
                const button = document.getElementById('soundToggle');
                button.innerHTML = this.soundEnabled ? 'üîä' : 'üîá';
                button.className = `sound-toggle ${this.soundEnabled ? '' : 'sound-off'}`;
            }
            
            playAlertSound() {
                if (this.soundEnabled && this.alertSound) {
                    this.alertSound.currentTime = 0;
                    this.alertSound.play().catch(e => console.log('Could not play sound:', e));
                }
            }
        }
        
        // Global functions for buttons
        async function manualScan() {
            try {
                const response = await fetch('/api/scan');
                const data = await response.json();
                console.log('Manual scan completed:', data);
                // The dashboard will auto-update via WebSocket or polling
            } catch (error) {
                console.error('Manual scan failed:', error);
            }
        }
        
        function clearAlerts() {
            const container = document.getElementById('alerts-container');
            container.innerHTML = '<div class="loading">No active alerts</div>';
        }
        
        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.txDashboard = new TXDashboard();
        });
    </script>
</body>
</html>